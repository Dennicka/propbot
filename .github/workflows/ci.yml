name: CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Secret scan
        run: python scripts/ci_secret_scan.py

  lint:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Ruff lint
        run: ruff check app tests
      - name: Black check
        run: black --check app tests
      - name: Mypy
        run: mypy app

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - env:
          PYTHONPATH: .
          CI_TESTING: "1"
        run: python -m pytest -q
      - name: Golden replay check
        if: hashFiles('data/golden/baseline.jsonl') != ''
        run: make golden-check

  security-sweep:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install bandit pip-audit
      - name: Bandit static analysis
        run: bandit -q -r app services
      - name: Dependency audit
        run: pip-audit -r requirements.txt

  acceptance:
    needs: [test, security-sweep]
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      PYTHONPATH: .
      CHAOS_ENABLED: ${{ vars.CHAOS_ENABLED || secrets.CHAOS_ENABLED || 'false' }}
      CI_TESTING: '1'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Acceptance smoke suite
        run: make acceptance_smoke
      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-smoke-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance trading suite
        run: make acceptance_trading
      - name: Upload trading artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-trading-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance chaos suite
        if: env.CHAOS_ENABLED == 'true' || env.CHAOS_ENABLED == '1'
        env:
          CHAOS_ENABLED: 'true'
        run: make acceptance_chaos
      - name: Upload chaos artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-chaos-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
