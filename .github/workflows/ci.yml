name: CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Secret scan
        run: python scripts/ci_secret_scan.py

  lint:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Ruff lint
        run: ruff check .
      - name: Black check
        run: black --check .
      - name: Mypy
        run: mypy --config-file mypy.ini app

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - env:
          PYTHONPATH: .
          CI_TESTING: "1"
        run: python -m pytest -q
      - name: Golden replay check
        if: hashFiles('data/golden/baseline.jsonl') != ''
        run: make golden-check

  golden-master:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Golden trading flows
        env:
          PYTHONPATH: .
          CI_TESTING: "1"
        run: python -m pytest -q tests/golden

  self-check:
    needs: golden-master
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Self-check (paper profile)
        env:
          PYTHONPATH: .
          PROFILE: paper
          TRADING_PROFILE: paper
          APPROVE_TOKEN: ci-approve
          AUTH_ENABLED: 'false'
          API_TOKEN: ci-token
          DRY_RUN_MODE: 'true'
          SAFE_MODE: 'true'
          TELEGRAM_ENABLE: 'false'
          AUTO_HEDGE_ENABLED: 'false'
          MAX_OPEN_POSITIONS: '3'
          MAX_NOTIONAL_PER_POSITION_USDT: '1000'
          MAX_TOTAL_NOTIONAL_USDT: '5000'
          MAX_LEVERAGE: '3'
          RUNTIME_STATE_PATH: ${{ github.workspace }}/.selfcheck/runtime_state.json
          POSITIONS_STORE_PATH: ${{ github.workspace }}/.selfcheck/positions.json
          HEDGE_LOG_PATH: ${{ github.workspace }}/.selfcheck/hedge_log.json
          PNL_HISTORY_PATH: ${{ github.workspace }}/.selfcheck/pnl_history.json
          OPS_ALERTS_FILE: ${{ github.workspace }}/.selfcheck/ops_alerts.json
          OPS_APPROVALS_FILE: ${{ github.workspace }}/.selfcheck/ops_approvals.json
        run: |
          mkdir -p .selfcheck
          python -m app.services.self_check --profile paper

  security-sweep:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install bandit pip-audit
      - name: Bandit static analysis
        run: bandit -q -r app services
      - name: Dependency audit
        run: |
          pip-audit -r requirements.txt \
            --ignore-vuln GHSA-f96h-pmfr-66vw \
            --ignore-vuln GHSA-2c2j-9gv5-cj73

  acceptance:
    needs: [test, security-sweep, golden-master, self-check]
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      PYTHONPATH: .
      CHAOS_ENABLED: ${{ vars.CHAOS_ENABLED || secrets.CHAOS_ENABLED || 'false' }}
      CI_TESTING: '1'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Acceptance smoke suite
        run: make acceptance_smoke
      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-smoke-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance trading suite
        run: make acceptance_trading
      - name: Upload trading artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-trading-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance chaos suite
        if: env.CHAOS_ENABLED == 'true' || env.CHAOS_ENABLED == '1'
        env:
          CHAOS_ENABLED: 'true'
        run: make acceptance_chaos
      - name: Upload chaos artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-chaos-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
