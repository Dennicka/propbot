name: CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - env:
          PYTHONPATH: .
        run: python -m pytest -q
  acceptance:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      PYTHONPATH: .
      CHAOS_ENABLED: ${{ vars.CHAOS_ENABLED || secrets.CHAOS_ENABLED || 'false' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Acceptance smoke suite
        run: make acceptance_smoke
      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-smoke-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance trading suite
        run: make acceptance_trading
      - name: Upload trading artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-trading-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
      - name: Acceptance chaos suite
        if: env.CHAOS_ENABLED == 'true' || env.CHAOS_ENABLED == '1'
        env:
          CHAOS_ENABLED: 'true'
        run: make acceptance_chaos
      - name: Upload chaos artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-chaos-logs
          path: |
            logs/*.log
            reports/ops_report*.json
            reports/ops_report*.csv
          if-no-files-found: ignore
