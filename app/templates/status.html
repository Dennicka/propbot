<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>PropBot System Status</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: #f8fafc;
      }
      header {
        padding: 1.5rem 2rem;
        background: #1e293b;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      main {
        padding: 1.5rem 2rem 3rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
      }
      .card {
        background: #1e293b;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.45);
        position: relative;
      }
      h1, h2 {
        margin: 0;
      }
      button {
        background: #38bdf8;
        border: none;
        color: #0f172a;
        font-weight: bold;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.15s ease, opacity 0.2s ease;
      }
      button:hover {
        transform: translateY(-1px);
        opacity: 0.9;
      }
      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      button.secondary {
        background: #fbbf24;
        color: #1f2937;
      }
      button.danger {
        background: #f87171;
        color: #0f172a;
      }
      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        text-align: left;
        padding: 0.35rem 0.3rem;
        vertical-align: middle;
      }
      th {
        border-bottom: 1px solid rgba(248, 250, 252, 0.2);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      td {
        font-size: 0.9rem;
      }
      .table-wrapper {
        overflow-x: auto;
      }
      .table-wrapper + .table-wrapper {
        margin-top: 0.75rem;
      }
      .mini-table th,
      .mini-table td {
        font-size: 0.8rem;
      }
      .risk-section {
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(248, 250, 252, 0.08);
      }
      .risk-section:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
      }
      .risk-metric {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
      }
      .risk-metric + .risk-metric {
        margin-top: 0.25rem;
      }
      .risk-metric span.value {
        font-weight: 600;
      }
      .control-values {
        margin-top: 0.75rem;
        display: grid;
        gap: 0.35rem;
        font-size: 0.85rem;
      }
      .control-entry {
        display: flex;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .control-entry span.key {
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.85);
      }
      .control-entry span.value {
        font-weight: 600;
        text-align: right;
      }
      .good {
        color: #4ade80;
      }
      .bad {
        color: #f87171;
      }
      .muted {
        color: rgba(148, 163, 184, 0.85);
      }
      .plan-summary,
      .plan-reason {
        margin-top: 0.75rem;
        line-height: 1.4;
      }
      .plan-spread {
        margin-top: 0.5rem;
        line-height: 1.4;
      }
      .card-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
      }
      .tab-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
      }
      .tab-button {
        background: rgba(148, 163, 184, 0.2);
        color: #e2e8f0;
        font-weight: 600;
      }
      .tab-button.active {
        background: #38bdf8;
        color: #0f172a;
      }
      .tab-panel {
        display: none;
      }
      .tab-panel.active {
        display: block;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.45rem;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }
      .code-block {
        background: rgba(15, 23, 42, 0.65);
        border-radius: 8px;
        padding: 0.75rem 0.85rem;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 0.8rem;
        overflow-x: auto;
        margin-top: 0.5rem;
      }
      .badge-info {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
      }
      .badge-warning {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }
      .badge-error {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      .events-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 360px;
        overflow-y: auto;
        padding-right: 0.25rem;
      }
      .event-row {
        background: rgba(15, 23, 42, 0.6);
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        display: grid;
        grid-template-columns: auto auto 1fr;
        gap: 0.5rem 0.75rem;
        align-items: center;
      }
      .event-time {
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.85);
      }
      .event-context {
        display: grid;
        gap: 0.35rem;
      }
      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.95);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .event-meta span {
        background: rgba(148, 163, 184, 0.2);
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
      }
      .event-meta span.type {
        background: rgba(56, 189, 248, 0.2);
        color: #38bdf8;
      }
      .event-message {
        font-size: 0.8rem;
        color: rgba(226, 232, 240, 0.88);
        word-break: break-word;
      }
      .event-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.75rem;
      }
      .event-filters {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .event-filter {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .event-filter label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(148, 163, 184, 0.85);
      }
      .event-filter input,
      .event-filter select {
        background: rgba(148, 163, 184, 0.15);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 6px;
        color: #f8fafc;
        padding: 0.35rem 0.55rem;
        font-size: 0.85rem;
      }
      .event-filter input::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }
      .event-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .events-meta {
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.85);
      }
      .events-meta {
        font-size: 0.75rem;
        color: rgba(148, 163, 184, 0.85);
      }
      .total-row {
        border-top: 1px solid rgba(248, 250, 252, 0.2);
        font-weight: 600;
      }
      .total-row td {
        padding-top: 0.45rem;
      }
      select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: #f8fafc;
        padding: 0.35rem 0.5rem;
        border-radius: 6px;
      }
      .toast {
        position: fixed;
        top: 1.5rem;
        right: 2rem;
        background: rgba(15, 23, 42, 0.95);
        color: #f8fafc;
        border-radius: 10px;
        padding: 0.75rem 1.2rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.25s ease, transform 0.25s ease;
        z-index: 20;
        min-width: 220px;
        font-weight: 600;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .toast.success {
        border-left: 4px solid #4ade80;
      }
      .toast.error {
        border-left: 4px solid #f87171;
      }
      .autopilot-banner {
        margin-bottom: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        display: block;
      }
      .autopilot-banner-warning {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        color: #92400e;
      }
      .autopilot-banner-error {
        background: #fee2e2;
        border: 1px solid #fca5a5;
        color: #b91c1c;
      }
      .autopilot-status {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #f8fafc;
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        backdrop-filter: blur(2px);
        z-index: 30;
      }
      .modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 40;
      }
      .modal.hidden,
      .modal-backdrop.hidden,
      .toast.hidden {
        display: none;
      }
      .hidden {
        display: none;
      }
      .modal-content {
        background: #0f172a;
        border-radius: 16px;
        padding: 1.5rem;
        width: min(520px, 92vw);
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.6);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .modal-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem 1rem;
      }
      .modal-form label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .modal-form input[type="number"],
      .modal-form input[type="text"] {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.35);
        border-radius: 8px;
        padding: 0.45rem 0.6rem;
        color: #f8fafc;
      }
      .modal-form input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #38bdf8;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1.2rem;
      }
      @media (max-width: 768px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }
        .actions {
          justify-content: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>PropBot System Status</h1>
        <p id="mode">Loading...</p>
      </div>
      <div class="actions">
        <button id="editConfigBtn" class="secondary">Edit Config</button>
        <button id="resumeBtn">Resume</button>
        <button id="holdBtn">Hold</button>
        <button id="stopBtn" class="secondary">Stop</button>
      </div>
    </header>
    <div id="toast" class="toast hidden"></div>
    <main>
      <section class="card">
        <h2>Auto Loop</h2>
        <div id="loopStatus" class="plan-summary muted">Status: --</div>
        <div id="loopConfig" class="plan-summary muted"></div>
        <div id="loopCounters" class="plan-summary muted"></div>
        <div id="loopSummary" class="plan-reason muted"></div>
      </section>
      <section class="card">
        <h2>Runtime Flags</h2>
        <div id="autopilotBanner" class="autopilot-banner hidden"></div>
        <div id="autopilotStatus" class="autopilot-status muted">autopilot_status: loading…</div>
        <div id="flags"></div>
        <div id="controlValues" class="control-values muted"></div>
      </section>
      <section class="card">
        <h2>Exposures</h2>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Venue</th>
                <th>Venue Type</th>
                <th>Symbol</th>
                <th>Qty</th>
                <th>Notional</th>
                <th>Entry</th>
                <th>Mark</th>
                <th>uPnL</th>
                <th>rPnL</th>
              </tr>
            </thead>
            <tbody id="exposures"></tbody>
          </table>
        </div>
        <div class="table-wrapper">
          <h3>Balances</h3>
          <table class="mini-table">
            <thead>
              <tr>
                <th>Venue</th>
                <th>Asset</th>
                <th>Free</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="portfolioBalances"></tbody>
          </table>
        </div>
      </section>
      <section class="card">
        <h2>PnL</h2>
        <div id="pnl"></div>
      </section>
      <section class="card">
        <h2>Daily PnL / Ops summary</h2>
        <div id="dailySummary" class="muted">Loading…</div>
        <div id="dailyStats" class="control-values"></div>
        <div id="dailyNotes" class="muted" style="margin-top:0.5rem;font-size:0.75rem;"></div>
      </section>
      <section class="card">
        <h2>Forensics snapshot</h2>
        <p class="muted" style="margin-bottom:0.75rem;">
          Export the current runtime flags, hedge positions (including partial legs), pending approvals,
          execution slippage stats, reconciliation alerts, and the latest daily report for audit or investor reviews.
        </p>
        <button id="snapshotInfoBtn">Generate snapshot</button>
        <p class="muted" style="margin-top:0.75rem;font-size:0.8rem;">
          Endpoint: <code>/api/ui/snapshot</code> (Bearer <code>$API_TOKEN</code> required).
        </p>
        <pre id="snapshotCurlExample" class="code-block">curl -H 'Authorization: Bearer $API_TOKEN' https://your-host/api/ui/snapshot</pre>
      </section>
      <section class="card">
        <h2>Risk</h2>
        <div class="card-actions">
          <button id="killBtn" class="danger">Kill Switch</button>
        </div>
        <div class="risk-section">
          <h3>Limits</h3>
          <div id="riskLimits" class="muted">Loading…</div>
        </div>
        <div class="risk-section">
          <h3>Current</h3>
          <div id="riskCurrent" class="muted">Loading…</div>
        </div>
        <div class="risk-section">
          <h3>Daily loss cap</h3>
          <div id="botLossCap" class="muted">Not configured</div>
        </div>
        <div class="risk-section">
          <h3>Breaches</h3>
          <div id="riskBreaches" class="muted">No active breaches</div>
        </div>
      </section>
      <section class="card">
        <h2>Orders &amp; Positions</h2>
        <div class="card-actions">
          <div class="actions" style="justify-content:flex-start;">
            <button id="closeExposureBtn" class="secondary">Close Exposure</button>
            <button id="cancelAllBtn" class="danger">Cancel All</button>
          </div>
          <div id="venueCancelButtons" class="actions" style="justify-content:flex-end;"></div>
        </div>
        <div class="tab-group">
          <button class="tab-button active" data-tab-target="orders">Open Orders</button>
          <button class="tab-button" data-tab-target="positions">Positions</button>
          <button class="tab-button" data-tab-target="fills">Fills</button>
        </div>
        <div class="tab-panel active" data-tab-panel="orders">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Venue</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="openOrders"></tbody>
            </table>
          </div>
        </div>
        <div class="tab-panel" data-tab-panel="positions">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Venue</th>
                  <th>Symbol</th>
                  <th>Qty</th>
                  <th>Entry</th>
                  <th>Mark</th>
                  <th>uPnL</th>
                  <th>rPnL</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="positions"></tbody>
            </table>
          </div>
        </div>
        <div class="tab-panel" data-tab-panel="fills">
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Venue</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Qty</th>
                  <th>Price</th>
                  <th>Fee</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="recentFills"></tbody>
            </table>
          </div>
        </div>
      </section>
      <section class="card">
        <h2>Last Plan</h2>
        <div id="loopState" class="muted">Auto-loop: --</div>
        <div id="lastPlanSummary" class="plan-summary muted">No plan recorded</div>
        <div id="lastPlanSpread" class="plan-spread"></div>
        <table id="lastPlanLegs" class="plan-legs"></table>
        <div id="lastPlanReason" class="plan-reason"></div>
      </section>
      <section class="card">
        <h2>Events</h2>
        <div class="event-controls">
          <div class="event-filters">
            <div class="event-filter">
              <label for="eventVenue">Venue</label>
              <input id="eventVenue" type="text" placeholder="e.g. binance-um" />
            </div>
            <div class="event-filter">
              <label for="eventLevel">Level</label>
              <select id="eventLevel">
                <option value="all">All</option>
                <option value="info">Info</option>
                <option value="warning">Warning</option>
                <option value="error">Error</option>
              </select>
            </div>
            <div class="event-filter">
              <label for="eventSearch">Search</label>
              <input id="eventSearch" type="text" placeholder="Message contains" />
            </div>
          </div>
          <div class="event-actions">
            <span id="eventsMeta" class="events-meta"></span>
            <button id="downloadEventsBtn" style="padding:0.4rem 0.8rem;">Download CSV</button>
            <button id="loadMoreEventsBtn" class="secondary" style="padding:0.4rem 0.8rem;">Load more</button>
          </div>
        </div>
        <div id="events" class="events-list"></div>
      </section>
    </main>

    <div id="modalBackdrop" class="modal-backdrop hidden"></div>
    <div id="configModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Runtime Config</h3>
          <button id="closeConfigBtn" class="danger" style="padding:0.4rem 0.8rem;">Close</button>
        </div>
        <form id="configForm" class="modal-form">
          <label>
            Min spread (bps)
            <input type="number" step="0.01" min="0" name="min_spread_bps" />
          </label>
          <label>
            Max slippage (bps)
            <input type="number" step="1" min="0" max="1000" name="max_slippage_bps" />
          </label>
          <label>
            Order notional (USDT)
            <input type="number" step="0.01" min="0.01" name="order_notional_usdt" />
          </label>
          <label>
            Loop pair
            <input type="text" name="loop_pair" placeholder="e.g. BTCUSDT" />
          </label>
          <label>
            Loop venues (comma separated)
            <input type="text" name="loop_venues" placeholder="binance-um, okx-perp" />
          </label>
          <label style="flex-direction:row; align-items:center; gap:0.5rem;">
            <input type="checkbox" name="safe_mode" /> SAFE_MODE
          </label>
          <label style="flex-direction:row; align-items:center; gap:0.5rem;">
            <input type="checkbox" name="dry_run_only" /> Dry-run only
          </label>
          <label style="flex-direction:row; align-items:center; gap:0.5rem;">
            <input type="checkbox" name="two_man_rule" /> Two-man rule
          </label>
          <label style="flex-direction:row; align-items:center; gap:0.5rem;">
            <input type="checkbox" name="auto_loop" /> Auto loop enabled
          </label>
        </form>
        <div class="modal-footer">
          <button id="saveConfigBtn">Apply Patch</button>
        </div>
        <p class="muted" style="font-size:0.75rem; margin-top:0.5rem;">
          Changes available only in paper/testnet profiles while SAFE_MODE is enabled.
        </p>
      </div>
    </div>
    <script>
      const holdBtn = document.getElementById('holdBtn');
      const resumeBtn = document.getElementById('resumeBtn');
      const stopBtn = document.getElementById('stopBtn');
      const killBtn = document.getElementById('killBtn');
      const cancelAllBtn = document.getElementById('cancelAllBtn');
      const closeExposureBtn = document.getElementById('closeExposureBtn');
      const editConfigBtn = document.getElementById('editConfigBtn');
      const autopilotBannerEl = document.getElementById('autopilotBanner');
      const autopilotStatusEl = document.getElementById('autopilotStatus');
      const loopStatusEl = document.getElementById('loopStatus');
      const loopConfigEl = document.getElementById('loopConfig');
      const loopCountersEl = document.getElementById('loopCounters');
      const loopSummaryEl = document.getElementById('loopSummary');
      const openOrdersBody = document.getElementById('openOrders');
      const positionsBody = document.getElementById('positions');
      const recentFillsBody = document.getElementById('recentFills');
      const dailySummaryEl = document.getElementById('dailySummary');
      const dailyStatsEl = document.getElementById('dailyStats');
      const dailyNotesEl = document.getElementById('dailyNotes');
      const snapshotInfoBtn = document.getElementById('snapshotInfoBtn');
      const snapshotCurlEl = document.getElementById('snapshotCurlExample');
      const exposuresBody = document.getElementById('exposures');
      const balancesBody = document.getElementById('portfolioBalances');
      const riskLimitsEl = document.getElementById('riskLimits');
      const riskCurrentEl = document.getElementById('riskCurrent');
      const riskBreachesEl = document.getElementById('riskBreaches');
      const botLossCapEl = document.getElementById('botLossCap');
      const eventsContainer = document.getElementById('events');
      const eventLevelSelect = document.getElementById('eventLevel');
      const eventVenueInput = document.getElementById('eventVenue');
      const eventSearchInput = document.getElementById('eventSearch');
      const downloadEventsBtn = document.getElementById('downloadEventsBtn');
      const controlValuesEl = document.getElementById('controlValues');
      const eventsMetaEl = document.getElementById('eventsMeta');
      const loadMoreEventsBtn = document.getElementById('loadMoreEventsBtn');
      const toastEl = document.getElementById('toast');
      const modalBackdrop = document.getElementById('modalBackdrop');
      const configModal = document.getElementById('configModal');
      const closeConfigBtn = document.getElementById('closeConfigBtn');
      const configForm = document.getElementById('configForm');
      const saveConfigBtn = document.getElementById('saveConfigBtn');
      const venueCancelButtons = document.getElementById('venueCancelButtons');
      const tabButtons = Array.from(document.querySelectorAll('[data-tab-target]'));
      const tabPanels = Array.from(document.querySelectorAll('[data-tab-panel]'));

      const EVENTS_LIMIT = 100;

      const state = {
        env: 'paper',
        eventsItems: [],
        eventsPage: { total: 0, offset: 0, limit: EVENTS_LIMIT, order: 'desc', has_more: false },
        eventsFilters: { level: 'all', venue: '', search: '' },
        eventsHasMore: false,
        eventsNextOffset: 0,
        eventsLocked: false,
        control: null,
        secret: null,
        orders: { open_orders: [], positions: [], fills: [] },
      };

      let toastTimer = null;

      const showToast = (message, kind = 'success') => {
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.classList.remove('hidden', 'success', 'error');
        toastEl.classList.add('show', kind);
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toastEl.classList.remove('show');
          toastEl.classList.add('hidden');
        }, 3500);
      };

      const formatNumber = (value, digits = 2) => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) {
          return (0).toFixed(digits);
        }
        return numeric.toFixed(digits);
      };

      const signedSpan = (value, digits = 2) => {
        const numeric = Number(value);
        const cls = numeric >= 0 ? 'good' : 'bad';
        return `<span class="${cls}">${formatNumber(numeric, digits)}</span>`;
      };

      const escapeHtml = (value) => {
        if (value === null || value === undefined) {
          return '';
        }
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      };

      const debounce = (fn, delay = 300) => {
        let timer = null;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn(...args), delay);
        };
      };

      const buildSnapshotCurl = () => {
        const origin = String(window.location.origin || '').replace(/\/$/, '');
        return `curl -H 'Authorization: Bearer $API_TOKEN' ${origin}/api/ui/snapshot`;
      };

      if (snapshotCurlEl) {
        snapshotCurlEl.textContent = buildSnapshotCurl();
      }

      if (snapshotInfoBtn) {
        snapshotInfoBtn.addEventListener('click', () => {
          showToast(`Run: ${buildSnapshotCurl()}`, 'success');
        });
      }

      const eventsFiltersAreDefault = () =>
        state.eventsFilters.level === 'all' && !state.eventsFilters.venue && !state.eventsFilters.search;

      const syncEventsLock = () => {
        const baseLimit = Number(state.eventsPage?.limit ?? EVENTS_LIMIT);
        state.eventsLocked = !eventsFiltersAreDefault() || state.eventsItems.length > baseLimit;
      };

      const buildEventsParams = (overrides = {}) => {
        const params = new URLSearchParams();
        const limitValue = Math.min(
          Number(overrides.limit ?? state.eventsPage?.limit ?? EVENTS_LIMIT) || EVENTS_LIMIT,
          1000
        );
        params.set('limit', limitValue);
        const offsetValue = Math.max(0, Number(overrides.offset ?? 0));
        params.set('offset', offsetValue);
        const orderValue = String(overrides.order ?? state.eventsPage?.order ?? 'desc').toLowerCase();
        params.set('order', orderValue);
        const levelValue = overrides.level ?? state.eventsFilters.level;
        if (levelValue && levelValue !== 'all') {
          params.set('level', levelValue);
        }
        const venueValue = overrides.venue ?? state.eventsFilters.venue;
        if (venueValue) {
          params.set('venue', venueValue);
        }
        const searchValue = overrides.search ?? state.eventsFilters.search;
        if (searchValue) {
          params.set('search', searchValue);
        }
        if (overrides.format) {
          params.set('format', overrides.format);
        }
        if (overrides.since) {
          params.set('since', overrides.since);
        }
        if (overrides.until) {
          params.set('until', overrides.until);
        }
        return params;
      };

      const buildEventsExportUrl = () => {
        const maxLimit = Math.min(
          Number(state.eventsPage?.total ?? state.eventsPage?.limit ?? EVENTS_LIMIT) || EVENTS_LIMIT,
          1000
        );
        const params = buildEventsParams({ offset: 0, limit: maxLimit, format: 'csv' });
        const url = new URL('/api/ui/events/export', window.location.origin);
        params.forEach((value, key) => url.searchParams.set(key, value));
        return url.toString();
      };

      const updateEventsDownloadState = () => {
        if (!downloadEventsBtn) return;
        downloadEventsBtn.disabled = state.eventsItems.length === 0;
        downloadEventsBtn.setAttribute('data-href', buildEventsExportUrl());
      };

      const activateTab = (name) => {
        tabButtons.forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.tabTarget === name);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle('active', panel.dataset.tabPanel === name);
        });
      };

      tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
      });

      const openModal = () => {
        populateConfigForm(state.control);
        modalBackdrop.classList.remove('hidden');
        configModal.classList.remove('hidden');
      };

      const closeModal = () => {
        configModal.classList.add('hidden');
        modalBackdrop.classList.add('hidden');
      };

      modalBackdrop.addEventListener('click', closeModal);
      closeConfigBtn.addEventListener('click', closeModal);
      editConfigBtn.addEventListener('click', openModal);

      const populateConfigForm = (control) => {
        if (!control) return;
        configForm.elements['min_spread_bps'].value = control.min_spread_bps ?? '';
        configForm.elements['max_slippage_bps'].value = control.max_slippage_bps ?? '';
        configForm.elements['order_notional_usdt'].value = control.order_notional_usdt ?? '';
        configForm.elements['loop_pair'].value = control.loop_pair || '';
        configForm.elements['loop_venues'].value = Array.isArray(control.loop_venues)
          ? control.loop_venues.join(', ')
          : '';
        configForm.elements['safe_mode'].checked = Boolean(control.safe_mode);
        configForm.elements['dry_run_only'].checked = Boolean(control.dry_run);
        configForm.elements['two_man_rule'].checked = Boolean(control.two_man_rule);
        configForm.elements['auto_loop'].checked = Boolean(control.auto_loop);
      };
      const renderRisk = (risk) => {
        if (!risk || typeof risk !== 'object') {
          riskLimitsEl.textContent = 'No limits configured';
          riskCurrentEl.textContent = 'Unavailable';
          riskBreachesEl.textContent = 'No data';
          riskBreachesEl.classList.add('muted');
          renderBotLossCap(null);
          return;
        }
        const limits = risk.limits || {};
        const current = risk.current || {};
        const breaches = Array.isArray(risk.breaches) ? risk.breaches : [];

        const limitLines = [];
        const positionLimits = limits.max_position_usdt || {};
        const openOrderLimits = limits.max_open_orders || {};
        const dailyLossLimit = limits.max_daily_loss_usdt;
        const formatLimitKey = (key) => (key === '__default__' ? 'ALL' : key);
        Object.entries(positionLimits).forEach(([symbol, value]) => {
          limitLines.push(
            `<div class="risk-metric"><span>Pos ${formatLimitKey(symbol)}</span><span class="value">${formatNumber(value)}</span></div>`
          );
        });
        Object.entries(openOrderLimits).forEach(([venue, value]) => {
          limitLines.push(
            `<div class="risk-metric"><span>Orders ${formatLimitKey(venue)}</span><span class="value">${Number(value)}</span></div>`
          );
        });
        if (dailyLossLimit !== null && dailyLossLimit !== undefined) {
          const limitValue = Number(dailyLossLimit);
          if (Number.isFinite(limitValue)) {
            limitLines.push(
              `<div class="risk-metric"><span>Daily loss</span><span class="value">${formatNumber(limitValue)}</span></div>`
            );
          }
        }
        riskLimitsEl.innerHTML = limitLines.length ? limitLines.join('') : 'No limits configured';

        const currentLines = [];
        const positions = current.position_usdt || {};
        Object.entries(positions).forEach(([symbol, value]) => {
          currentLines.push(
            `<div class="risk-metric"><span>${symbol}</span><span class="value">${formatNumber(value)}</span></div>`
          );
        });
        const openOrders = current.open_orders || {};
        Object.entries(openOrders).forEach(([venue, count]) => {
          currentLines.push(
            `<div class="risk-metric"><span>Orders ${venue}</span><span class="value">${Number(count)}</span></div>`
          );
        });
        if (current.daily_loss_usdt !== undefined) {
          currentLines.push(
            `<div class="risk-metric"><span>Daily realized</span><span class="value">${formatNumber(current.daily_loss_usdt)}</span></div>`
          );
        }
        riskCurrentEl.innerHTML = currentLines.length ? currentLines.join('') : 'No telemetry available';

        if (breaches.length) {
          const breachLines = breaches.map((breach) => {
            const limit = breach.limit || '';
            const scope = breach.scope || '';
            const currentValue = formatNumber(breach.current ?? 0);
            const thresholdValue = formatNumber(breach.threshold ?? 0);
            const detail = breach.detail ? ` · ${breach.detail}` : '';
            const detailLine = detail ? `<div class="muted" style="font-size:0.8rem;">${detail}</div>` : '';
            return `<div class="risk-metric"><span>${limit} ${scope}</span><span class="value">${currentValue} / ${thresholdValue}</span></div>${detailLine}`;
          });
          riskBreachesEl.innerHTML = breachLines.join('');
          riskBreachesEl.classList.remove('muted');
        } else {
          riskBreachesEl.textContent = 'No active breaches';
          riskBreachesEl.classList.add('muted');
        }
      };

      function renderBotLossCap(lossCap) {
        if (!botLossCapEl) return;
        if (!lossCap || typeof lossCap !== 'object') {
          botLossCapEl.textContent = 'Not configured';
          botLossCapEl.classList.add('muted');
          return;
        }
        const capValue = Number(lossCap.cap_usdt ?? lossCap.cap);
        if (!Number.isFinite(capValue) || capValue <= 0) {
          botLossCapEl.textContent = 'Cap disabled';
          botLossCapEl.classList.add('muted');
          return;
        }
        const realizedValue = Number(lossCap.realized_today_usdt ?? 0);
        const remainingRaw = lossCap.remaining_usdt;
        const remainingValue = Number(remainingRaw);
        const breached = Boolean(lossCap.breached);
        const statusIcon = breached ? '🔴' : '🟢';
        const statusText = breached ? 'Breached' : 'OK';
        const statusClass = breached ? 'value bad' : 'value good';
        const remainingClass = Number.isFinite(remainingValue)
          ? `value ${remainingValue >= 0 ? 'good' : 'bad'}`
          : 'value muted';
        const remainingLabel = Number.isFinite(remainingValue)
          ? formatNumber(remainingValue)
          : '—';
        const lines = [
          `<div class="risk-metric"><span>Status</span><span class="${statusClass}">${statusIcon} ${statusText}</span></div>`,
          `<div class="risk-metric"><span>Cap</span><span class="value">${formatNumber(capValue)}</span></div>`,
          `<div class="risk-metric"><span>Realized</span><span class="value">${formatNumber(realizedValue)}</span></div>`,
          `<div class="risk-metric"><span>Remaining</span><span class="${remainingClass}">${remainingLabel}</span></div>`,
        ];
        botLossCapEl.classList.remove('muted');
        botLossCapEl.innerHTML = lines.join('');
      }

      const renderLoopOverview = (loopInfo, secret, env, ordersCount) => {
        const running = Boolean(loopInfo?.running);
        const statusLabel = running ? 'RUNNING' : String(loopInfo?.status || 'IDLE').toUpperCase();
        loopStatusEl.textContent = `Status: ${statusLabel}`;

        const pair = loopInfo?.pair || secret?.pair || 'N/A';
        const venues = Array.isArray(loopInfo?.venues) && loopInfo.venues.length
          ? loopInfo.venues.join(' ↔ ')
          : (Array.isArray(secret?.venues) ? secret.venues.join(' ↔ ') : '');
        const notionalValue = loopInfo?.notional_usdt ?? secret?.notional_usdt;
        const parts = [`Pair: ${pair}`];
        if (venues) {
          parts.push(`Venues: ${venues}`);
        }
        if (Number.isFinite(Number(notionalValue))) {
          parts.push(`Notional: ${Number(notionalValue).toFixed(2)} USDT`);
        }
        loopConfigEl.textContent = parts.join(' · ');

        const cycles = loopInfo?.cycles_completed ?? 0;
        const lastTs = loopInfo?.last_cycle_ts ? new Date(loopInfo.last_cycle_ts).toLocaleString() : null;
        loopCountersEl.textContent = lastTs
          ? `Cycles: ${cycles} · Last: ${lastTs}`
          : `Cycles: ${cycles}`;

        const summary = loopInfo?.last_summary;
        if (summary) {
          const pnlValue = Number(summary.est_pnl_usdt);
          const statusText = String(summary.status || '').toUpperCase();
          let summaryParts = [`Last cycle: ${statusText}`];
          if (Number.isFinite(pnlValue)) {
            summaryParts.push(`PnL: ${pnlValue.toFixed(4)} USDT`);
          }
          const spreadBps = Number(summary.spread_bps);
          if (Number.isFinite(spreadBps)) {
            summaryParts.push(`Spread: ${spreadBps.toFixed(2)} bps`);
          }
          if (summary.reason) {
            summaryParts.push(`Reason: ${summary.reason}`);
          }
          loopSummaryEl.textContent = summaryParts.join(' · ');
          loopSummaryEl.classList.remove('muted');
        } else {
          loopSummaryEl.textContent = 'No cycles yet';
          loopSummaryEl.classList.add('muted');
        }

        stopBtn.disabled = !running;
        const envIsTestnet = env === 'testnet';
        cancelAllBtn.dataset.env = env;
        const allowCancel = envIsTestnet && ordersCount > 0;
        cancelAllBtn.disabled = !allowCancel;
        cancelAllBtn.title = allowCancel
          ? ''
          : envIsTestnet
            ? 'No open orders to cancel'
            : 'Cancel-all requires testnet environment';
      };

      const renderControlSnapshot = (control) => {
        if (!controlValuesEl) return;
        if (!control || typeof control !== 'object') {
          controlValuesEl.innerHTML = '<div class="muted">Control unavailable</div>';
          return;
        }
        const entries = Object.entries(control).filter(([key]) => key !== 'approvals');
        if (!entries.length) {
          controlValuesEl.innerHTML = '<div class="muted">Control unavailable</div>';
          return;
        }
        const html = entries
          .map(([key, value]) => {
            let display = '—';
            if (Array.isArray(value)) {
              display = value.length ? value.join(', ') : '—';
            } else if (value === null || value === undefined) {
              display = '—';
            } else if (typeof value === 'object') {
              display = JSON.stringify(value);
            } else if (typeof value === 'boolean') {
              display = value ? 'enabled' : 'disabled';
            } else if (typeof value === 'number') {
              display = formatNumber(value, Math.abs(value) < 1 ? 4 : 2);
            } else {
              display = String(value);
            }
            return `<div class="control-entry"><span class="key">${key}</span><span class="value">${display}</span></div>`;
          })
          .join('');
        controlValuesEl.innerHTML = html;
      };

      const renderAutopilot = (payload) => {
        if (!autopilotStatusEl || !autopilotBannerEl) return;
        autopilotStatusEl.classList.add('muted');
        autopilotStatusEl.textContent = 'autopilot_status: unavailable';
        autopilotBannerEl.textContent = '';
        autopilotBannerEl.classList.add('hidden');
        autopilotBannerEl.classList.remove('autopilot-banner-warning', 'autopilot-banner-error');
        if (!payload || typeof payload !== 'object') {
          return;
        }
        const enabled = Boolean(payload.enabled);
        const actionRaw = String(payload.last_action || 'none');
        const actionLower = actionRaw.toLowerCase();
        const reasonRaw = payload.last_reason ? String(payload.last_reason) : 'n/a';
        const attemptTs = payload.last_attempt_ts ? new Date(payload.last_attempt_ts).toLocaleString() : null;
        const statusParts = [
          `autopilot_status: <strong>${escapeHtml(enabled ? 'enabled' : 'disabled')}</strong>`,
          `last_autopilot_action: <strong>${escapeHtml(actionRaw)}</strong>`,
          `last_autopilot_reason: <strong>${escapeHtml(reasonRaw)}</strong>`,
        ];
        if (attemptTs) {
          statusParts.push(`last_attempt: ${escapeHtml(attemptTs)}`);
        }
        autopilotStatusEl.innerHTML = statusParts.join(' · ');
        if (enabled) {
          autopilotStatusEl.classList.remove('muted');
        }
        autopilotBannerEl.classList.remove('autopilot-banner-warning', 'autopilot-banner-error');
        autopilotBannerEl.classList.add('hidden');
        const reasonSafe = escapeHtml(reasonRaw);
        if (enabled && Boolean(payload.armed)) {
          autopilotBannerEl.textContent = 'AUTOPILOT ARMED — trading WITHOUT human two-man approval';
          autopilotBannerEl.classList.add('autopilot-banner-warning');
          autopilotBannerEl.classList.remove('hidden');
        } else if (enabled && actionLower === 'refused') {
          autopilotBannerEl.textContent = `AUTOPILOT refused to arm — ${reasonSafe}`;
          autopilotBannerEl.classList.add('autopilot-banner-error');
          autopilotBannerEl.classList.remove('hidden');
        }
      };

      const renderEvents = () => {
        const rows = Array.isArray(state.eventsItems) ? state.eventsItems : [];
        if (!rows.length) {
          eventsContainer.innerHTML = '<div class="muted">No events matching filters</div>';
        } else {
          const html = rows
            .map((event) => {
              const levelText = String(event.level || 'INFO').toLowerCase();
              const badgeClass = levelText.startsWith('error')
                ? 'badge-error'
                : levelText.startsWith('warning')
                  ? 'badge-warning'
                  : 'badge-info';
              const ts = event.ts ? new Date(event.ts).toLocaleString() : '';
              const venue = event.venue ? escapeHtml(event.venue) : '—';
              const symbol = event.symbol ? `<span class="event-meta-item">${escapeHtml(event.symbol)}</span>` : '';
              const type = event.type || event.code ? `<span class="type">${escapeHtml(event.type || event.code)}</span>` : '';
              const messageRaw = event.message ? escapeHtml(event.message) : '';
              const messageHtml = messageRaw || '<span class="muted">No details</span>';
              return `
                <div class="event-row">
                  <div class="event-time">${ts}</div>
                  <span class="badge ${badgeClass}">${levelText}</span>
                  <div class="event-context">
                    <div class="event-meta">
                      <span class="event-meta-item">${venue}</span>
                      ${symbol}
                      ${type}
                    </div>
                    <div class="event-message">${messageHtml}</div>
                  </div>
                </div>`;
            })
            .join('');
          eventsContainer.innerHTML = html;
        }
        if (eventsMetaEl) {
          const totalLoaded = state.eventsItems.length;
          const total = Number(state.eventsPage?.total ?? totalLoaded);
          eventsMetaEl.textContent = total ? `Showing ${totalLoaded} of ${total}` : `${totalLoaded} loaded`;
        }
        if (loadMoreEventsBtn) {
          loadMoreEventsBtn.disabled = !state.eventsHasMore;
          loadMoreEventsBtn.textContent = state.eventsHasMore ? 'Load more' : 'No more';
        }
        updateEventsDownloadState();
      };

      const renderDailyReport = (payload, statusCode) => {
        if (!dailySummaryEl || !dailyStatsEl) return;
        if (dailyNotesEl) {
          dailyNotesEl.textContent = '';
        }
        if (statusCode && [401, 403].includes(Number(statusCode))) {
          dailySummaryEl.textContent = 'Daily report requires authorization.';
          dailySummaryEl.classList.remove('muted');
          dailySummaryEl.classList.add('bad');
          dailyStatsEl.innerHTML = '';
          return;
        }
        dailySummaryEl.classList.remove('bad');
        if (!payload || payload.available === false || Object.keys(payload).length === 0) {
          dailySummaryEl.textContent = 'No daily report captured in the last 24 hours.';
          dailySummaryEl.classList.add('muted');
          dailyStatsEl.innerHTML = '';
          return;
        }
        dailySummaryEl.classList.remove('muted');
        const timestamp = payload.timestamp ? new Date(payload.timestamp).toLocaleString() : 'n/a';
        const windowHours = Number(payload.window_hours ?? 24) || 24;
        dailySummaryEl.textContent = `Last snapshot: ${timestamp} (window ${windowHours}h)`;
        const realized = formatNumber(payload.pnl_realized_total ?? payload.pnl_realized ?? 0, 2);
        const unrealized = formatNumber(payload.pnl_unrealized_avg ?? payload.pnl_unrealized_latest ?? 0, 2);
        const exposure = formatNumber(payload.exposure_avg ?? 0, 2);
        const slippageAvg = payload.slippage_avg_bps;
        const slippage = slippageAvg === null || slippageAvg === undefined
          ? 'n/a'
          : formatNumber(slippageAvg, Math.abs(slippageAvg) < 1 ? 4 : 2);
        const breakdown = (payload.hold_breakdown && typeof payload.hold_breakdown === 'object')
          ? payload.hold_breakdown
          : {};
        const holdTotal = Number(payload.hold_events ?? 0);
        const autoHolds = Number(breakdown.safety_hold ?? breakdown.auto ?? 0);
        const throttles = Number(breakdown.risk_throttle ?? breakdown.throttle ?? 0);
        dailyStatsEl.innerHTML = [
          `<div class="control-entry"><span class="key">PnL realized (24h)</span><span class="value">${realized}</span></div>`,
          `<div class="control-entry"><span class="key">Unrealized PnL avg</span><span class="value">${unrealized}</span></div>`,
          `<div class="control-entry"><span class="key">Avg exposure (USD)</span><span class="value">${exposure}</span></div>`,
          `<div class="control-entry"><span class="key">Avg slippage (bps)</span><span class="value">${slippage}</span></div>`,
          `<div class="control-entry"><span class="key">HOLD / throttle</span><span class="value">${holdTotal} (auto ${autoHolds}, throttle ${throttles})</span></div>`,
        ].join('');
        if (dailyNotesEl) {
          const pnlSamples = Number(payload.pnl_unrealized_samples ?? 0);
          const exposureSamples = Number(payload.exposure_samples ?? 0);
          const slippageSamples = Number(payload.slippage_samples ?? 0);
          dailyNotesEl.textContent = `Samples — PnL: ${pnlSamples}, exposure: ${exposureSamples}, slippage: ${slippageSamples}`;
        }
      };
      if (eventLevelSelect) {
        eventLevelSelect.value = state.eventsFilters.level;
        eventLevelSelect.addEventListener('change', async () => {
          state.eventsFilters.level = eventLevelSelect.value || 'all';
          await fetchEvents({ offset: 0, append: false });
        });
      }
      if (eventVenueInput) {
        eventVenueInput.value = state.eventsFilters.venue;
        const handleVenueInput = debounce(async (value) => {
          state.eventsFilters.venue = value.trim();
          await fetchEvents({ offset: 0, append: false });
        });
        eventVenueInput.addEventListener('input', (event) => {
          handleVenueInput(event.target.value || '');
        });
      }
      if (eventSearchInput) {
        eventSearchInput.value = state.eventsFilters.search;
        const handleSearchInput = debounce(async (value) => {
          state.eventsFilters.search = value.trim();
          await fetchEvents({ offset: 0, append: false });
        });
        eventSearchInput.addEventListener('input', (event) => {
          handleSearchInput(event.target.value || '');
        });
      }
      if (downloadEventsBtn) {
        downloadEventsBtn.addEventListener('click', () => {
          if (downloadEventsBtn.disabled) return;
          const href = downloadEventsBtn.getAttribute('data-href') || buildEventsExportUrl();
          window.open(href, '_blank');
        });
      }
      if (loadMoreEventsBtn) {
        loadMoreEventsBtn.addEventListener('click', async () => {
          await loadMoreEvents();
        });
      }
      const renderOrders = (orders, env) => {
        const rows = Array.isArray(orders) ? orders : [];
        openOrdersBody.innerHTML = rows.length
          ? rows
              .map(
                (order) => `
                  <tr>
                    <td>${order.venue ?? ''}</td>
                    <td>${order.symbol ?? ''}</td>
                    <td>${String(order.side ?? '').toUpperCase()}</td>
                    <td>${Number(order.qty ?? 0).toFixed(4)}</td>
                    <td>${Number(order.price ?? 0).toFixed(4)}</td>
                    <td>${String(order.status ?? '').toUpperCase()}</td>
                  </tr>`
              )
              .join('')
          : '<tr><td colspan="6" class="muted">No open orders</td></tr>';

        const envIsTestnet = env === 'testnet';
        if (!rows.length || !envIsTestnet) {
          venueCancelButtons.innerHTML = '';
          return;
        }
        const venues = Array.from(new Set(rows.map((row) => String(row.venue || '').toLowerCase()))).filter(Boolean);
        venueCancelButtons.innerHTML = venues
          .map(
            (venue) => `<button data-cancel-venue="${venue}" class="danger" style="padding:0.45rem 0.8rem;">Cancel ${venue}</button>`
          )
          .join('');
        venueCancelButtons.querySelectorAll('button[data-cancel-venue]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const venue = btn.getAttribute('data-cancel-venue');
            invokeAction('/api/ui/cancel_all', { venue });
          });
        });
      };

      const renderPositions = (positions) => {
        const rows = Array.isArray(positions) ? positions : [];
        positionsBody.innerHTML = rows.length
          ? rows
              .map((row) => {
                const venue = row.venue ?? '';
                const symbol = row.symbol ?? '';
                const qty = Number(row.qty ?? row.base_qty ?? 0);
                const entry = Number(row.entry_px ?? row.avg_entry ?? row.avg_price ?? 0);
                const mark = Number(row.mark_px ?? row.mark ?? entry);
                const upnl = row.upnl !== undefined ? Number(row.upnl) : (mark - entry) * qty;
                const rpnl = Number(row.rpnl ?? 0);
                return `
                  <tr>
                    <td>${venue}</td>
                    <td>${symbol}</td>
                    <td>${formatNumber(qty, 4)}</td>
                    <td>${formatNumber(entry)}</td>
                    <td>${formatNumber(mark)}</td>
                    <td>${signedSpan(upnl)}</td>
                    <td>${signedSpan(rpnl)}</td>
                    <td><button class="secondary" data-close-pos="${venue}|${symbol}" style="padding:0.4rem 0.6rem;">Close</button></td>
                  </tr>`;
              })
              .join('')
          : '<tr><td colspan="8" class="muted">No positions</td></tr>';

        positionsBody.querySelectorAll('button[data-close-pos]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const [venue, symbol] = btn.getAttribute('data-close-pos').split('|');
            invokeAction('/api/ui/close_exposure', { venue, symbol });
          });
        });
      };

      const renderFills = (fills) => {
        const rows = Array.isArray(fills) ? fills : [];
        recentFillsBody.innerHTML = rows.length
          ? rows
              .map(
                (fill) => `
                  <tr>
                    <td>${fill.venue ?? ''}</td>
                    <td>${fill.symbol ?? ''}</td>
                    <td>${String(fill.side ?? '').toUpperCase()}</td>
                    <td>${Number(fill.qty ?? 0).toFixed(4)}</td>
                    <td>${Number(fill.price ?? 0).toFixed(4)}</td>
                    <td>${Number(fill.fee ?? 0).toFixed(4)}</td>
                    <td>${fill.ts ? new Date(fill.ts).toLocaleString() : ''}</td>
                  </tr>`
              )
              .join('')
          : '<tr><td colspan="7" class="muted">No fills recorded</td></tr>';
      };

      const renderPortfolio = (data) => {
        const portfolioData = data.portfolio || {};
        const portfolioPositions = Array.isArray(portfolioData.positions) && portfolioData.positions.length
          ? portfolioData.positions
          : (data.exposures || []);
        exposuresBody.innerHTML = portfolioPositions.length
          ? portfolioPositions
              .map((row) => {
                const venue = row.venue ?? '';
                const venueType = row.venue_type ?? state.env ?? '';
                const symbol = row.symbol ?? '';
                const qty = Number(row.qty ?? row.base_qty ?? 0);
                const entry = Number(row.entry_px ?? row.avg_entry ?? row.avg_price ?? 0);
                const mark = Number(row.mark_px ?? row.mark ?? entry);
                const notional = Number(row.notional ?? Math.abs(qty) * mark);
                const upnl = row.upnl !== undefined ? Number(row.upnl) : (mark - entry) * qty;
                const rpnl = Number(row.rpnl ?? 0);
                return `
                  <tr>
                    <td>${venue}</td>
                    <td>${venueType}</td>
                    <td>${symbol}</td>
                    <td>${formatNumber(qty, 4)}</td>
                    <td>${formatNumber(notional)}</td>
                    <td>${formatNumber(entry)}</td>
                    <td>${formatNumber(mark)}</td>
                    <td>${signedSpan(upnl)}</td>
                    <td>${signedSpan(rpnl)}</td>
                  </tr>`;
              })
              .join('')
          : '<tr><td colspan="9" class="muted">No positions</td></tr>';

        const balances = Array.isArray(portfolioData.balances) ? portfolioData.balances : [];
        if (balances.length) {
          let usdtTotal = 0;
          const rowsHtml = balances
            .map((row) => {
              const asset = String(row.asset ?? '').toUpperCase();
              const freeValue = Number(row.free ?? row.qty ?? 0);
              const totalValue = Number(row.total ?? row.balance ?? row.qty ?? 0);
              if (asset === 'USDT') {
                usdtTotal += totalValue;
              }
              return `
                <tr>
                  <td>${row.venue ?? ''}</td>
                  <td>${asset}</td>
                  <td>${formatNumber(freeValue, 4)}</td>
                  <td>${formatNumber(totalValue, 4)}</td>
                </tr>`;
            })
            .join('');
          const totalRow = `
            <tr class="total-row">
              <td colspan="2">Total USDT</td>
              <td colspan="2">${formatNumber(usdtTotal, 4)}</td>
            </tr>`;
          balancesBody.innerHTML = rowsHtml + totalRow;
        } else {
          balancesBody.innerHTML = '<tr><td colspan="4" class="muted">No balances</td></tr>';
        }

        const pnl = portfolioData.pnl_totals || data.pnl || {};
        const totalPnl = Number(pnl.total ?? 0);
        const realizedPnl = Number(pnl.realized ?? 0);
        const unrealizedPnl = Number(pnl.unrealized ?? 0);
        document.getElementById('pnl').innerHTML = `
          <div>Realized: <span class="${realizedPnl >= 0 ? 'good' : 'bad'}">${realizedPnl.toFixed(2)}</span> USDT</div>
          <div>Unrealized: <span class="${unrealizedPnl >= 0 ? 'good' : 'bad'}">${unrealizedPnl.toFixed(2)}</span> USDT</div>
          <div>Total: <span class="${totalPnl >= 0 ? 'good' : 'bad'}">${totalPnl.toFixed(2)}</span> USDT</div>`;

        const allowCloseExposure = Array.isArray(portfolioPositions) && portfolioPositions.length > 0;
        closeExposureBtn.disabled = !allowCloseExposure;
        closeExposureBtn.title = allowCloseExposure ? '' : 'No exposure to close';

        renderPositions(portfolioPositions);
      };
      const invokeAction = async (path, payload = undefined, method = 'POST') => {
        const options = { method };
        if (payload !== undefined) {
          options.headers = { 'Content-Type': 'application/json' };
          options.body = JSON.stringify(payload);
        }
        try {
          const resp = await fetch(path, options);
          if (!resp.ok) {
            const error = await resp.json().catch(() => ({}));
            throw new Error(error.detail || resp.statusText || 'Action failed');
          }
          showToast('Action applied', 'success');
        } catch (error) {
          showToast(error.message || 'Action failed', 'error');
        } finally {
          await fetchState();
        }
      };

      const fetchState = async () => {
        try {
          const [stateResp, secretResp, ordersResp] = await Promise.all([
            fetch('/api/ui/state'),
            fetch('/api/ui/secret'),
            fetch('/api/ui/orders'),
          ]);
          if (!stateResp.ok) {
            throw new Error('failed to load state');
          }
          const data = await stateResp.json();
          state.control = data.control || state.control;
          const eventsBlock = data.events || {};
          const eventItems = Array.isArray(eventsBlock.items) ? eventsBlock.items : [];
          const eventTotal = Number(eventsBlock.total ?? eventItems.length);
          const eventLimit = Number(eventsBlock.limit ?? EVENTS_LIMIT);
          const eventOffset = Number(eventsBlock.offset ?? 0);
          const eventOrder = eventsBlock.order || state.eventsPage.order || 'desc';
          const eventHasMore = Boolean(eventsBlock.has_more);
          const eventNext = Number(eventsBlock.next_offset ?? eventOffset + eventItems.length);
          state.eventsPage = {
            total: eventTotal,
            offset: eventOffset,
            limit: eventLimit,
            order: eventOrder,
          };
          state.eventsHasMore = eventHasMore;
          state.eventsNextOffset = eventNext;
          if (!state.eventsLocked && eventsFiltersAreDefault()) {
            state.eventsItems = eventItems.slice();
            syncEventsLock();
          }
          document.getElementById('mode').textContent = `Mode: ${data.mode}`;
          const env = String((data.flags && (data.flags.ENV || data.flags.MODE)) || '').toLowerCase();
          state.env = env || state.env;
          const flagLines = Object.entries(data.flags || {})
            .map(([key, value]) => `<div>${key}: <strong>${value}</strong></div>`)
            .join('');
          document.getElementById('flags').innerHTML = flagLines;
          renderControlSnapshot(state.control);
          renderAutopilot(data.autopilot || {});
          renderRisk(data.risk);
          const lossCapSnapshot =
            data.bot_loss_cap || (data.risk_accounting && data.risk_accounting.bot_loss_cap) || null;
          renderBotLossCap(lossCapSnapshot);

          if (secretResp.ok) {
            state.secret = await secretResp.json();
          }
          if (ordersResp.ok) {
            state.orders = await ordersResp.json();
          }

          renderPortfolio(data);
          renderOrders(state.orders.open_orders, state.env);
          renderFills(state.orders.fills);
          renderLoopOverview(data.loop, state.secret, state.env, state.orders.open_orders.length);
          renderEvents();
          renderLastPlan(data.last_plan, data.loop, state.secret);

          let dailyReportPayload = null;
          let dailyReportStatus = null;
          try {
            const dailyResp = await fetch('/api/ui/daily_report');
            dailyReportStatus = dailyResp.status;
            if (dailyResp.ok) {
              dailyReportPayload = await dailyResp.json();
            }
          } catch (dailyError) {
            console.debug('Failed to load daily report', dailyError);
          }
          renderDailyReport(dailyReportPayload, dailyReportStatus);

          resumeBtn.disabled = Boolean(data.safe_mode);
        } catch (error) {
          console.error('Failed to refresh state', error);
          showToast('Failed to refresh state', 'error');
        }
      };

      const collectFormPayload = () => {
        const payload = {};
        const minSpread = configForm.elements['min_spread_bps'].value;
        if (minSpread !== '') payload.min_spread_bps = Number(minSpread);
        const maxSlippage = configForm.elements['max_slippage_bps'].value;
        if (maxSlippage !== '') payload.max_slippage_bps = Number(maxSlippage);
        const notional = configForm.elements['order_notional_usdt'].value;
        if (notional !== '') payload.order_notional_usdt = Number(notional);
        const loopPair = configForm.elements['loop_pair'].value.trim();
        if (loopPair) payload.loop_pair = loopPair.toUpperCase();
        const loopVenuesRaw = configForm.elements['loop_venues'].value;
        if (loopVenuesRaw) {
          payload.loop_venues = loopVenuesRaw
            .split(',')
            .map((entry) => entry.trim())
            .filter((entry) => entry.length > 0);
        }
        payload.safe_mode = configForm.elements['safe_mode'].checked;
        payload.dry_run_only = configForm.elements['dry_run_only'].checked;
        payload.two_man_rule = configForm.elements['two_man_rule'].checked;
        payload.auto_loop = configForm.elements['auto_loop'].checked;
        return payload;
      };

      const fetchEvents = async ({ offset = 0, append = false } = {}) => {
        const params = buildEventsParams({ offset });
        if (loadMoreEventsBtn) {
          loadMoreEventsBtn.disabled = true;
        }
        try {
          const resp = await fetch(`/api/ui/events?${params.toString()}`);
          if (!resp.ok) {
            throw new Error('failed to load events');
          }
          const page = await resp.json();
          const items = Array.isArray(page.items) ? page.items : [];
          if (append) {
            state.eventsItems = state.eventsItems.concat(items);
          } else {
            state.eventsItems = items;
          }
          state.eventsPage = {
            total: Number(page.total ?? state.eventsItems.length),
            offset: Number(page.offset ?? offset),
            limit: Number(page.limit ?? state.eventsPage.limit ?? EVENTS_LIMIT),
            order: page.order || state.eventsPage.order || 'desc',
          };
          state.eventsHasMore = Boolean(page.has_more);
          state.eventsNextOffset = Number(page.next_offset ?? state.eventsPage.offset + items.length);
          syncEventsLock();
          renderEvents();
        } catch (error) {
          console.error('Failed to load events', error);
          showToast('Failed to load events', 'error');
        } finally {
          if (loadMoreEventsBtn) {
            loadMoreEventsBtn.disabled = !state.eventsHasMore;
            loadMoreEventsBtn.textContent = state.eventsHasMore ? 'Load more' : 'No more';
          }
        }
      };

      const loadMoreEvents = async () => {
        const nextOffset = Number.isFinite(state.eventsNextOffset)
          ? Number(state.eventsNextOffset)
          : state.eventsItems.length;
        await fetchEvents({ offset: nextOffset, append: true });
      };

      const submitConfig = async (event) => {
        event.preventDefault();
        const payload = collectFormPayload();
        saveConfigBtn.disabled = true;
        try {
          const resp = await fetch('/api/ui/control', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const error = await resp.json().catch(() => ({}));
            throw new Error(error.detail || resp.statusText || 'Failed to patch control');
          }
          const result = await resp.json().catch(() => ({}));
          state.control = result.control || state.control;
          showToast('Runtime control updated', 'success');
          closeModal();
          await fetchState();
        } catch (error) {
          showToast(error.message || 'Failed to update config', 'error');
        } finally {
          saveConfigBtn.disabled = false;
        }
      };

      holdBtn.addEventListener('click', () => invokeAction('/api/ui/hold'));
      resumeBtn.addEventListener('click', () => invokeAction('/api/ui/resume'));
      stopBtn.addEventListener('click', () => invokeAction('/api/ui/stop'));
      killBtn.addEventListener('click', () => invokeAction('/api/ui/kill'));
      cancelAllBtn.addEventListener('click', () => invokeAction('/api/ui/cancel_all'));
      closeExposureBtn.addEventListener('click', () => invokeAction('/api/ui/close_exposure'));
      configForm.addEventListener('submit', submitConfig);
      saveConfigBtn.addEventListener('click', submitConfig);

      fetchState();
      setInterval(fetchState, 4000);
    </script>
  </body>
</html>
