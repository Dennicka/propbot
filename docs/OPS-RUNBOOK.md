# OPS RUNBOOK (v1)

## 1. Profiles & Modes
- `EXEC_PROFILE`: paper | testnet | live. Определяет набор эндпоинтов, допустимые лимиты и поведение оркестратора. Меняем только с подтверждённым чеклистом.
- `SAFE_MODE`: аварийный режим блокировки ордеров. Включается через `SAFE_MODE=1`, выключается `SAFE_MODE=0`. Не отключать без подтверждённой причины и записи в журнале инцидента.
- Канареечный запуск: стартуем с минимальных лимитов и уменьшенным размером позиций, проверяем обновление метрик и отсутствие предупреждений. Обязательно сравниваем латентности с paper и убеждаемся, что risk-ограничения остаются активными.

## 2. Quick Start (Paper)
1. Подготовка локальной среды: `make fmt && make test`.
2. Дымовые/acceptance проверки: `make smoke-accept` (прогоняет минимальные сценарии с golden-файлами).
3. Запуск paper-профиля: `EXEC_PROFILE=paper uvicorn app.main:app --reload` или через вспомогательный скрипт CLI (`python api_cli.py run --profile paper`). Логи смотреть в stdout или в `data/logs/paper.log` (если включён файл-логгер).

## 3. Quick Start (Testnet)
- Минимальный набор переменных: `EXEC_PROFILE=testnet`, ключи адаптеров (API key/secret), `SAFE_MODE=1` на старте, testnet endpoints в конфиге.
- Dry-run: прогоняем `make smoke-guard`, убеждаемся что readiness и risk-флаги не блокируют запуск. Проверяем, что тестовые ключи не совпадают с боевыми.
- Перед открытием позиций снимаем метрики (`make metrics-tail`) и убеждаемся, что адаптеры прогреваются без ошибок авторизации.

## 4. Live Guard & Confirm
- READINESS агрегатор (`FF_READINESS_AGG_GUARD`): требует активных сигналов от market data, recon и адаптеров перед разрешением ордеров.
- `LIVE_CONFIRM`: строка-подтверждение, которую вводит оператор перед переводом профиля в live. Должна быть зафиксирована в журнале смены.
- Блокировки подачи могут сработать из-за: включённого safe-mode, live-guard без всех сигналов, stale-p95 латентностей, риск-лимитов, `dupe-intent` защит, cooldown по роутеру, истечения timeout'ов подтверждения.

## 5. ENV & Flags (ссылаться на docs/ENV.md)
- Все флаги задаём через переменные окружения (`export VAR=value` или `.env` файл). Подробности и значения по умолчанию — в [docs/ENV.md](ENV.md).
- Пример `.env` можно получить командой `make env-sample` и адаптировать под конкретную среду.

## 6. Metrics & Monitoring
- `METRICS_PATH`: путь до Prometheus textfile (по умолчанию `data/metrics/metrics.prom`). Для локального tail используем `make metrics-tail`.
- Ключевые метрики: `propbot_orders_*` (статусы и ошибки ордеров), `propbot_router_latency_ms*_` (латентность роутинга), а также readiness gauge'и.
- Проверка обновления: после деплоя прогоняем acceptance (`make smoke-accept`) и убеждаемся, что счётчики и таймеры увеличиваются в соответствии с ожиданиями.

## 7. Troubleshooting (частые фейлы)
- Black check would reformat → запускаем `make fmt`, пересматриваем дифф, коммитим форматирование.
- Bandit B101 assert → заменяем `assert` на явные проверки и `raise ValueError/RuntimeError` с описанием.
- Mypy типы Decimal/Optional → используем `Decimal` из `decimal`, описываем типы явно, при необходимости добавляем `Optional[Decimal]` и проверки на `None`.
- Secret-scan: не коммитим ключи. Для ложных срабатываний используем allowlist в конфиге scan'ера и пояснение в PR.
- Readiness-agg блокирует → убеждаемся, что `READINESS_REQUIRED` содержит все необходимые сигналы и что адаптеры публикуют их с TTL.
- Stale market-data → проверяем market-watchdog лимиты, снижает timeout обновления и форсируем ручной ресинк через CLI.
- Cooldown/dupe-intent блоки → сверяем окна и TTL, очищаем устаревшие ключи, при необходимости сбрасываем хранилище идемпотентности.

## 8. Rollback & Release
- Откат PR: используем GitHub Revert, проверяем, что реверт проходит CI, и деплоим фикс поверх него.
- Канареечный деплой: включаем минимальные объёмы, `SAFE_MODE=1` до завершения проверок, выключаем временные экспериментальные флаги.
- Чеклист перед live: readiness сигналы зелёные, risk-лимиты активны, подтверждён `LIVE_CONFIRM`, задокументированы окна идемпотентности и cooldown.

## 9. Smoke & Acceptance
- Локальный прогон только дымовых/acceptance тестов: `pytest -q tests/acceptance` или `make smoke-accept`.
- Обновление golden: только вручную, с разъяснением в PR. Выполняем `pytest tests/acceptance --update-golden` (если поддерживается), проверяем, что изменения осмыслены.

## 10. Incident Notes
- В отчёте об инциденте фиксируем: время (UTC), активный профиль, venue/биржу, причину отказа/блокировки, задействованные флаги, выдержки ключевых метрик и логов, решения/next steps.
